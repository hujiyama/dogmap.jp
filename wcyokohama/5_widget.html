<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<title>ウィジェットAPI - wokamoto</title>
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
<link rel="icon" type="image/x-icon" href="favicon.ico" />
<link rel="stylesheet" href="css/zoomooz.css" type="text/css" media="screen">
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen">
<link rel="stylesheet" href="css/shCore.css" type="text/css" media="screen">
<link rel="stylesheet" href="css/shThemeDefault.css" type="text/css" media="screen">
<style type="text/css" media="screen">/*<![CDATA[*/
.syntaxhighlighter code{display:inline;}
.screenshot {
/* opacity: 0.6; */
width: 100%;
height: 100%;
background-color: transparent;
background-repeat: no-repeat;
background-position: 0 0;
background-attachment: scroll;
}

#info_jseries {background-image:url(images/WordPress_Plugins-JSeries.png);}
#info_wp-plugins {background-image:url(images/WordPress_Plugins.png);}
#info_jquery-plugins {background-image:url(images/jQuery_Plugins.png);}

#hook-korosuke {background-image:url(images/korosuke.gif);background-position: right top;}
#hook-list {background-image:url(images/filter-hook.png);}
#hook-feed {background-image:url(images/rss-feed.png);background-position: right top;}
#hook-profile {background-image:url(images/profile.png);}

#short-register {background-image:url(images/wcyokohama-register.png);}
#short-attendees {background-image:url(images/wcyokohama-attendees.png);}

#register-wporg {background-image:url(images/register-wporg.png);}
#add-your-plugin {background-image:url(images/add-your-plugin.png);}
#request-approved {background-image:url(images/request-approved.png);}
/*]]>*/</style>
</head>

<body>

<!---------------------------------------------------------------------------------------->
	<div class="section section-title">
		<h2>ウィジェットAPI</h2>
		<p>
			WordPress 2.8 から、サイドバーに配置するためのウィジェットプラグインを簡単に作れるようになりました。
		</p>
	</div>

	<div class="section odd">
		<p>
			具体的には WordPress が提供する WP_Widget クラスを継承して、コンストラクタ・各種メソッドに処理を記述するだけで、ウィジェットプラグインが実装できるようになりました。
		</p>
<pre class="brush: php">
//クラス名は任意
class My_Widget extends WP_Widget {
	//コンストラクタ　クラスと同じ名称
	function My_Widget() {
		// ウィジェットの初期設定
	}

	function widget($args, $instance) {
		// ウィジェットのコンテンツ出力
	}

	function update($new_instance, $old_instance) {
		// 保存したときのウィジェットのオプションを処理
		// $new_instanceには入力データが連想配列で引き渡される
		// $old_instanceにはそれまでの保存されていたオプション値が連想配列で引き渡される。
		// 最後に連想配列でオプション値を返す。
	}

	function form($instance) {
		// 管理画面のウィジェットに出力するフォームを記述
		// $instanceには保存したオプションが連想配列で引き渡される。
	}
}
//MyWidgetInit関数
function MyWidgetInit() {
	//ウィジェットのクラス名を登録
	register_widget('My_Widget');
}
//widgets_initアクション時にMyWidgetInit関数を実行
add_action('widgets_init', 'MyWidgetInit');
</pre>
	</div>

	<div class="section even">
		<p>
			コンストラクタでは、基底クラスのコンストラクタを呼び出して初期処理してあげましょう。
		</p>
<pre class="brush: php">
    /** constructor */
    function My_Widget() {
        parent::WP_Widget(
		'MyWidget' ,
		'このウィジェットのタイトル' ,
		array(
			'classname' => 'widget_test_widget', 
			'description' => 'このウィジェットの説明'
			)
		);	
    }
</pre>
		<p>
			第1引数はウィジェットのID<br/>
			第2引数はウィジェットの表示タイトル<br />
			第3引数は、ウィジェットのオプションを連想配列で指定します。<br />
			classname は、サイトに表示されるウィジェットのクラス名(CSS)<br />
			description は、ダッシュボードに表示されるウィジェットの説明文
		</p>
	</div>

	<div class="section odd">
		<p>
			widget メソッドには、ウィジェットとしてサイトに出力する内容を記述します。<br />
			例えば、以下の用に記述すれば 'Hello World! と表示されるウィジェットが完成します。
		</p>
<pre class="brush: php">
    function widget($args, $instance) {
        // ウィジェットのコンテンツ出力
        echo $args['before_widget']."\n";
        echo $args['before_title'].'Hello World!'.$args['after_title']."\n";
        echo '&lt;p&gt;Hello World!&lt;/p&gt;'."\n";
        echo $args['after_widget']."\n";
    }
</pre>
		<p>
			第1引数には、各テーマのregister_sidebar関数で設定されたパラメータが連想配列で<br />
			第2引数には、データベースに保存されているウィジェットのオプションが連想配列で引き渡されます。
		</p>
		<p>
			また、サイトに出力されるコードには parent::WP_Widget() で指定した classname が自動的に付与されます。
		</p>
	</div>

	<div class="section even">
		<p>
			ダッシュボードのウィジェットにインプットボックスを設置するには form メソッドに HTML 出力を記述しましょう。
		</p>
		<p>
			第1引数には、データベースに保存されているウィジェットのオプションが連想配列で引き渡されます。<br />
			初めてウィジェットを使用するときは、データベースにオプションが保存されていないため、wp_parse_args() 関数で、デフォルト値を設定すると良いでしょう。
		</p>
<pre class="brush: php">
    function form($instance) {
        extract(wp_parse_args(
            (array) $instance ,
            array(
                'title' => '' ,
            )
        ), EXTR_SKIP);

        // title
        echo '&lt;p&gt;';
        echo '&lt;label for="'.$title['name'].'"&gt;' . __('Title:');
        echo '&lt;input class="widefat" id="'.$title['id'].'" name="'.$title['id'].'" type="text" value="'.$title['val'].'" /&gt;';
        echo '&lt;/label&gt;';
        echo '&lt;/p&gt;' . "\n";
    }
</pre>
	</div>

	<div class="section odd">
		<p>
			インプットボックスで入力された値をデータベースに保存するには update メソッドを記述しましょう。<br />
			入力されたオプション値のエラーチェック等を行い、最後に保存したいオプション値を連想配列で返してあげてください。
		</p>
<pre class="brush: php">
    function update($new_instance, $old_instance) {
        $new_instance = wp_parse_args(
            (array) $new_instance ,
            array(
                'title' => '' ,
            )
        );
        return (
            $new_instance !== $old_instance
            ? $new_instance
            : $old_instance
            );
    }
</pre>
		<p>
			第１引数には、入力されたオプション値<br />
			第2引数には、現在データベースに保存されているオプション値がセットされてきます。
		</p>
	</div>

	<div class="section even">
		<p>
			最後に widgets_init アクションフックに register_widget() 関数を呼び出す関数を登録すれば完了です。
		</p>
<pre class="brush: php">
//register_widget() 関数を呼び出す関数
function MyWidgetInit() {
    //ウィジェットのクラス名を登録
    register_widget('My_Widget');
}
add_action('widgets_init', 'MyWidgetInit');
</pre>
		<p>
			register_widget() 関数の第1引数には、WP_Widget クラスを継承して作成した Widget クラスのクラス名を記述してください。
		</p>
	</div>

	<div class="section odd">
		<p><a href="6_plugindir.html">公式プラグインディレクトリでの公開</a></p>
	</div>

<script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="js/sylvester.js"></script>
<script type="text/javascript" src="js/jquery.zoomooz.js"></script>

<script type="text/javascript" src="js/shCore.js"></script>
<script type="text/javascript" src="js/shBrushPhp.js"></script>
<!--
<script type="text/javascript" src="js/shBrushJScript.js"></script>
<script type="text/javascript" src="js/shBrushPlain.js"></script>
<script type="text/javascript" src="js/shBrushBash.js"></script>
-->

<script type="text/javascript">/*<![CDATA[*/
jQuery(function($) {
	with(SyntaxHighlighter.config.strings){
		expandSource="+ ソースを表示";
		viewSource="プレインテキスト";
		copyToClipboard="クリップボードにコピー";
		copyToClipboardConfirmation="クリップボードにコピーされました";
		print="印刷";
		help="?";
		noBrush="Can't find brush for: ";
		brushNotHtmlScript="Brush wasn't made for html-script option: ";
	}
	SyntaxHighlighter.config.clipboardSwf = "js/clipboard.swf";
//	SyntaxHighlighter.defaults["toolbar"] = false;
	SyntaxHighlighter.defaults["wrap-lines"] = false;
	SyntaxHighlighter.all()

	$(".section").click(function(evt) {
		$(this).zoomTo({targetsize:0.85, duration:600});
		evt.stopPropagation();
	});
	$(document).click(function(evt) {
		$("body").zoomTo({targetsize:1.0});
		evt.stopPropagation();
	});
	$(".section:last").unbind('click').click(function(evt) {
		$('.section').fadeOut('normal',function(){
			location.href='6_plugindir.html';
		});
	});
	$(".section:first").zoomTo({targetsize:0.85, duration:600});
});
/*]]>*/</script>

</body>
</html>
