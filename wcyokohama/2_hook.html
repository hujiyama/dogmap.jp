<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<title>フィルターフック・アクションフック - wokamoto</title>
<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
<link rel="icon" type="image/x-icon" href="favicon.ico" />
<link rel="stylesheet" href="css/zoomooz.css" type="text/css" media="screen">
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen">
<link rel="stylesheet" href="css/shCore.css" type="text/css" media="screen">
<link rel="stylesheet" href="css/shThemeDefault.css" type="text/css" media="screen">
<style type="text/css" media="screen">/*<![CDATA[*/
.syntaxhighlighter code{display:inline;}
.screenshot {
/* opacity: 0.6; */
width: 100%;
height: 100%;
background-color: transparent;
background-repeat: no-repeat;
background-position: 0 0;
background-attachment: scroll;
}

.syntaxhighlighter .line {
font-size:90%;
}

#info_jseries {background-image:url(images/WordPress_Plugins-JSeries.png);}
#info_wp-plugins {background-image:url(images/WordPress_Plugins.png);}
#info_jquery-plugins {background-image:url(images/jQuery_Plugins.png);}

#hook-korosuke {background-position: right top;}
#hook-list {background-image:url(images/filter-hook.png);}
#hook-feed {background-image:url(images/rss-feed.png);background-position: right top;}
#hook-profile {background-image:url(images/profile.png);}

#short-register {background-image:url(images/wcyokohama-register.png);}
#short-attendees {background-image:url(images/wcyokohama-attendees.png);}

#register-wporg {background-image:url(images/register-wporg.png);}
#add-your-plugin {background-image:url(images/add-your-plugin.png);}
#request-approved {background-image:url(images/request-approved.png);}
/*]]>*/</style>
</head>

<body>

<!---------------------------------------------------------------------------------------->
	<div class="section section-title" style="margin-top:0">
		<h2>フィルターフック・アクションフック</h2>
		<p>
			WordPress にはフィルターフック・アクションフックと
			呼ばれるプラグイン用の API が用意されています。
		</p>
		<p>
			これらのフックは、WordPress が動作する様々なタイミングで、
			プラグインから登録された関数があるか判断し、もしあれば
			その関数を走らせることによって、WordPress のデフォルトの
			動作を変更します。
		</p>
	</div>

	<div class="section odd">
		<p>
			例えば<code>「the_content」</code>というフィルターフックに関数を登録すれば、記事本文を変更できます。
		</p>
<pre class="brush: php">
function korosukenize( $content ) {
  $content = preg_replace(
    "/ます([。、]?)/" ,
    "るなりよ$1" ,
    $content );
  return $content;
}
add_filter('the_content', 'korosukenize');
</pre>
		<p class="screenshot" id="hook-korosuke">
			こんな感じのプラグインを書いてやるだけで、<br />
			記事本文の語尾をコロ助風に変換できます。
		</p>
	</div>

	<div class="section even">
		<h2>適切なフックを探すには？</h2>
		<p>
			では、自分のプラグインで使用したいフィルターフック・アクションフックを探すにはどうすれば良いでしょうか？<br />
			通常は、WordPress Codex の<a href="http://wpdocs.sourceforge.jp/%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3_API/%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%83%BC%E3%83%95%E3%83%83%E3%82%AF%E4%B8%80%E8%A6%A7" title="プラグイン API/フィルターフック一覧 - WordPress Codex 日本語版">フィルターフック一覧</a>、<a href="http://wpdocs.sourceforge.jp/%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3_API/%E3%82%A2%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%95%E3%83%83%E3%82%AF%E4%B8%80%E8%A6%A7" title="プラグイン API/アクションフック一覧 - WordPress Codex 日本語版">アクションフック一覧</a>を参照します。
		</p>
		<div class="screenshot" id="hook-list"></div>
	</div>

	<div class="section odd">
		<p>
			しかし Codex に詳しく載ってないような、マニアックな<br />
			フィルタフック・アクションフックを探したい時は、<br />
			どうすれば良いでしょうか？
		</p>
		<p>
			私の場合は WordPress のソースから使えそうな<br />
			アクションフック・フィルタフックを探します。
		</p>
		<p>
			ただし、WordPress のソースを頭から全部読んでたら<br />
			日が暮れるので、それらしいところのニオイを嗅ぎ分ける<br />
			鼻を養う必要があります。
		</p>
		<p>
			その辺のノウハウを実際の例を交えて簡単に説明します。
		</p>
	</div>

	<div class="section even">
		<h2>WordPress ソースの探索</h2>
		<p>
			以下の2点に注意して、WordPress ソース内を探検していきます。<br />
			使用する武器は grep 辺りが適切でしょう。
		</p>
		<ul>
			<li>アクションフックが適用されるのは、関数 do_action() が実行された時</li>
			<li>フィルタフックが適用されるのは、関数 apply_filters() が実行された時</li>
		</ul>
<!---
		<p>
			ちなみに do_action(), apply_filters() は、どちらもグローバル<br />
			変数の $wp_filter に登録されているフィルタに対して動作する<br />
			ので、これ以降はアクションフック・フィルタフックとも、<br />
			まとめてフィルタフックと呼びます。
		</p>
--->
	</div>

	<div class="section odd">
		<p>
			他の方法としては wp-includes/default-filters.php を眺めて見るのもアリです。<br />
			このファイルを眺めると、デフォルトで登録されているフィルタフックが確認できます。
		</p>
		<p>
			似たようなことをしている既存の WordPress プラグインのソースを見ても良いでしょう。<br />
			その場合は add_filter(), add_action() を探してみてください。
		</p>
		<p>
			では、使えるプラグインフックの探索方法を実例を交えて紹介します。
		</p>
	</div>

	<div class="section even">
		<h2>RSSフィードに独自のテンプレートを適用できるか？</h2>
		<p>
			RSSフィード用のテンプレートは、コアファイルにしか存在<br />
			しないため、通常の WordPress テーマでは、RSSフィードは<br />
			カスタマイズできません。<br />
			しかし、これを変更して右上にアイコンを表示したいとかの<br />
			要望が出てきたらどうすれば良いでしょうか？
		</p>
		<p>
			これは、適切なプラグインフックを使用することで実現できます。
		</p>
		<div class="screenshot" id="hook-feed"></div>
	</div>

	<div class="section odd">
		<p>
			フィードのテンプレートとしては wp-includes/feed-rss.php が読み込まれています。<br />
			これは、使用しているテーマに関わらず固定です。
		</p>
		<p>
			WordPress のソースを grep して feed-rss.php を読み込んでいるところを探索しましょう。
		</p>
		<p>
			→ wp-includes/functions.php の do_feed_rss() で読み込んでますね。
		</p>
<pre class="brush: php; first-line: 1663;">
/**
 * Load the RSS 1.0 Feed Template
 *
 * @since 2.1.0
 */
function do_feed_rss() {
	load_template( ABSPATH . WPINC . '/feed-rss.php' );
}
</pre>
	</div>

	<div class="section even">
		<p>
			続いて、この do_feed_rss() 関数を呼び出しているところを探索しましょう。
		</p>
		<p>
			→ wp-includes/default-filters.php の中で<br />
			　add_action('do_feed_rss', 'do_feed_rss', 10, 1); していますね。
		</p>
<pre class="brush: php; first-line: 192;">
// 2 Actions 2 Furious
add_action( 'do_feed_rdf',                'do_feed_rdf',             10, 1 );
add_action( 'do_feed_rss',                'do_feed_rss',             10, 1 );
add_action( 'do_feed_rss2',               'do_feed_rss2',            10, 1 );
add_action( 'do_feed_atom',               'do_feed_atom',            10, 1 );
add_action( 'do_pings',                   'do_all_pings',            10, 1 );
add_action( 'do_robots',                  'do_robots'                      );
add_action( 'sanitize_comment_cookies',   'sanitize_comment_cookies'       );
add_action( 'admin_print_scripts',        'print_head_scripts',      20    );
add_action( 'admin_print_footer_scripts', 'print_footer_scripts',    20    );
add_action( 'admin_print_styles',         'print_admin_styles',      20    );
add_action( 'init',                       'smilies_init',             5    );
add_action( 'plugins_loaded',             'wp_maybe_load_widgets',    0    );
add_action( 'plugins_loaded',             'wp_maybe_load_embeds',     0    );
add_action( 'shutdown',                   'wp_ob_end_flush_all',      1    );
add_action( 'pre_post_update',            'wp_save_post_revision'          );
add_action( 'publish_post',               '_publish_post_hook',       5, 1 );
add_action( 'future_post',                '_future_post_hook',        5, 2 );
add_action( 'future_page',                '_future_post_hook',        5, 2 );
add_action( 'save_post',                  '_save_post_hook',          5, 2 );
add_action( 'transition_post_status',     '_transition_post_status',  5, 3 );
add_action( 'comment_form', 'wp_comment_form_unfiltered_html_nonce'        );
add_action( 'wp_scheduled_delete',        'wp_scheduled_delete' );
</pre>
	</div>

	<div class="section odd">
		<p>
			このアクションフック do_feed_rss を実際に起動している<br />
			箇所を探索しましょう。
		</p>
		<p>
			→ wp-includes/functions.php の do_feed() 内で<br />
			　 'do_feed_' . $feed を do_action() しています。
		</p>
<pre class="brush: php; first-line: 1634;">
function do_feed() {
	global $wp_query;

	$feed = get_query_var( 'feed' );

	// Remove the pad, if present.
	$feed = preg_replace( '/^_+/', '', $feed );

	if ( $feed == '' || $feed == 'feed' )
		$feed = get_default_feed();

	$hook = 'do_feed_' . $feed;
	if ( !has_action($hook) ) {
		$message = sprintf( __( 'ERROR: %s is not a valid feed template' ), esc_html($feed));
		wp_die($message);
	}

	do_action( $hook, $wp_query->is_comment_feed );
}
</pre>
	</div>

	<div class="section even">
		<p>
			do_feed() 関数を実際に呼んでいるところを探索しましょう。
		</p>
		<p>
			→ wp-includes/template-loader.php の中で is_feed() なら、<br />
			　 この関数を呼んでますね。
		</p>
<pre class="brush: php; first-line: 6;">
if ( defined('WP_USE_THEMES') && constant('WP_USE_THEMES') ) {
	do_action('template_redirect');
	if ( is_robots() ) {
		do_action('do_robots');
		return;
	} else if ( is_feed() ) {
		do_feed();
		return;
	} else if ( is_trackback() ) {
		include(ABSPATH . 'wp-trackback.php');
		return;
	} else if ( is_404() && $template = get_404_template() ) {
		include($template);
		return;
	} else if ( is_search() && $template = get_search_template() ) {
		include($template);
		return;
	} else if ( is_tax() && $template = get_taxonomy_template()) {
		include($template);
		return;
</pre>
	</div>

	<div class="section odd">
		<p>
			これで、RSS フィードがリクエストされた場合、<br />
			WordPress が以下の動作をすることがわかりました。
		</p>
		<ol>
			<li>フィードがリクエストされたら do_feed() 関数を呼び出す</li>
			<li>do_feed() 関数が 'do_feed_rss' アクションフックを呼び出す</li>
			<li>アクションフックとして登録された do_feed_rss() 関数が動作する</li>
			<li>ABSPATH . WPINC . '/feed-rss.php' をテンプレートとしてロードする</li>
		</ol>
		<p>
			do_feed_rss() 関数の中では、テンプレートファイルは「ABSPATH . WPINC . '/feed-rss.php'」固定です。<br />
			しかし、この do_feed_rss() 関数はアクションフックとして登録されているため、このアクションフックをリムーブ後、独自のアクションフックを登録すれば、目的のことができそうですね。
		</p>
	</div>

	<div class="section even">
		<p>
			というわけで、テーマフォルダ内にあるRSSフィード用テンプレート(feed-rss.php)を読み込むプラグインができました。
		</p>
<pre class="brush: php">
// デフォルトアクションフック リムーブ
remove_filter('do_feed_rss', 'do_feed_rss', 10);

// アクションフック 追加
function custom_feed_rss( $for_comments ) {
	$template_file = '/feed-rss' . ( $for_comments ? '-comments' : '' ) . '.php';
	$template_file = ( file_exists( get_template_directory() . $template_file )
		? get_template_directory()
		: ABSPATH . WPINC
		) . $template_file;
	load_template( $template_file );
}
add_action('do_feed_rss', 'custom_feed_rss', 10);
</pre>
		<p>
			他のフィード ( rss2, atom ) についても、同様にしてやれば安心です。
		</p>
	</div>

	<div class="section odd">
		<p>
			WordCamp Yokohama 公式サイトのプロフィール登録画面のカスタマイズも、プラグインフックを登録するだけで実現しています。
		</p>
		<div class="screenshot" id="hook-profile">
		</div>
	</div>

	<div class="section even">
		<p>
			公式サイトのプロフィール登録画面で使用しているプラグインフックは以下のとおりです。
		</p>
		<ul>
			<li>profile_personal_options</li>
			<li>show_user_profile</li>
			<li>edit_user_profile</li>
			<li>personal_options_update</li>
			<li>edit_user_profile_update</li>
			<li>user_contactmethods</li>
			<li>admin_print</li>
			<li>admin_head-profile.php</li>
			<li>admin_footer-users.php</li>
			<li>manage_users_columns</li>
			<li>manage_users_custom_column</li>
		</ul>
	</div>

	<div class="section odd">
		<p><a href="3_pluggable.html">プラガブルファンクション</a></p>
	</div>

<script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="js/sylvester.js"></script>
<script type="text/javascript" src="js/jquery.zoomooz.js"></script>

<script type="text/javascript" src="js/shCore.js"></script>
<script type="text/javascript" src="js/shBrushPhp.js"></script>
<!--
<script type="text/javascript" src="js/shBrushJScript.js"></script>
<script type="text/javascript" src="js/shBrushPlain.js"></script>
<script type="text/javascript" src="js/shBrushBash.js"></script>
-->

<script type="text/javascript">/*<![CDATA[*/
jQuery(function($) {
	with(SyntaxHighlighter.config.strings){
		expandSource="+ ソースを表示";
		viewSource="プレインテキスト";
		copyToClipboard="クリップボードにコピー";
		copyToClipboardConfirmation="クリップボードにコピーされました";
		print="印刷";
		help="?";
		noBrush="Can't find brush for: ";
		brushNotHtmlScript="Brush wasn't made for html-script option: ";
	}
	SyntaxHighlighter.config.clipboardSwf = "js/clipboard.swf";
//	SyntaxHighlighter.defaults["toolbar"] = false;
	SyntaxHighlighter.defaults["wrap-lines"] = false;
	SyntaxHighlighter.all()

	$(".section").click(function(evt) {
		$(this).zoomTo({targetsize:0.85, duration:600});
		evt.stopPropagation();
	});
	$(document).click(function(evt) {
		$("body").zoomTo({targetsize:1.0});
		evt.stopPropagation();
	});

	$("#hook-korosuke").click(
		function(){
			$(this).fadeOut('normal', function(){
				$(this)
					.css('background-image','url(images/korosuke.png)')
					.html('こんな感じのプラグインを書いてやるだけで、<br />記事本文の語尾をコロ助風に変換できる<br />なりよ。')
					.fadeIn('normal');
			});
		});

	$(".section:last").unbind('click').click(function(evt) {
		$('.section').fadeOut('normal',function(){
			location.href='3_pluggable.html';
		});
	});
	$(".section:first").zoomTo({targetsize:0.85, duration:600});
});
/*]]>*/</script>

</body>
</html>
